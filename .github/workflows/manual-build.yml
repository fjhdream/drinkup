name: Manual Build and Publish Multi-Arch Image

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'è¦æ„å»ºçš„åˆ†æ”¯æˆ–æ ‡ç­¾ (ä¾‹å¦‚: master, v1.0.0, feature/xxx)'
        required: true
        default: 'master'
        type: string
      image_version:
        description: 'é•œåƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0, latest, dev)'
        required: true
        default: 'latest'
        type: string
      build_amd64:
        description: 'æ„å»º AMD64 æ¶æ„'
        required: true
        default: true
        type: boolean
      build_arm64:
        description: 'æ„å»º ARM64 æ¶æ„'
        required: true
        default: true
        type: boolean
      push_latest:
        description: 'æ˜¯å¦åŒæ—¶æ¨é€ latest æ ‡ç­¾'
        required: false
        default: false
        type: boolean
      sign_images:
        description: 'æ˜¯å¦ç­¾åé•œåƒ'
        required: false
        default: true
        type: boolean
      auto_version_from_tag:
        description: 'è‡ªåŠ¨ä½¿ç”¨æ ‡ç­¾åä½œä¸ºé•œåƒç‰ˆæœ¬ï¼ˆä»…å½“ ref æ˜¯æ ‡ç­¾æ—¶ç”Ÿæ•ˆï¼‰'
        required: false
        default: true
        type: boolean

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‡†å¤‡å·¥ä½œï¼šæ£€æµ‹å¼•ç”¨ç±»å‹å’ŒéªŒè¯è¾“å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prepare:
    runs-on: ubuntu-latest
    outputs:
      ref_type: ${{ steps.check_ref.outputs.ref_type }}
      final_image_version: ${{ steps.determine_version.outputs.version }}
      
    steps:
      - name: Checkout for ref check
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check ref type
        id: check_ref
        run: |
          # æ£€æŸ¥æ˜¯å¦ä¸ºæ ‡ç­¾
          if git show-ref --tags --verify --quiet "refs/tags/${{ inputs.ref }}"; then
            echo "ref_type=tag" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°æ ‡ç­¾: ${{ inputs.ref }}"
          # æ£€æŸ¥æ˜¯å¦ä¸ºåˆ†æ”¯
          elif git show-ref --heads --verify --quiet "refs/heads/${{ inputs.ref }}"; then
            echo "ref_type=branch" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°åˆ†æ”¯: ${{ inputs.ref }}"
          # æ£€æŸ¥æ˜¯å¦ä¸º commit SHA
          elif git cat-file -e "${{ inputs.ref }}^{commit}" 2>/dev/null; then
            echo "ref_type=commit" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°æäº¤: ${{ inputs.ref }}"
          else
            echo "âŒ æœªæ‰¾åˆ°æŒ‡å®šçš„å¼•ç”¨: ${{ inputs.ref }}"
            exit 1
          fi
          
      - name: Determine final image version
        id: determine_version
        run: |
          # å¦‚æœé€‰æ‹©äº†è‡ªåŠ¨ä½¿ç”¨æ ‡ç­¾åä¸”å½“å‰æ˜¯æ ‡ç­¾
          if [[ "${{ inputs.auto_version_from_tag }}" == "true" ]] && [[ "${{ steps.check_ref.outputs.ref_type }}" == "tag" ]]; then
            # ç§»é™¤å¯èƒ½çš„ 'v' å‰ç¼€
            version=$(echo "${{ inputs.ref }}" | sed 's/^v//')
            echo "version=$version" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ ä½¿ç”¨æ ‡ç­¾åä½œä¸ºé•œåƒç‰ˆæœ¬: $version"
          else
            echo "version=${{ inputs.image_version }}" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ ä½¿ç”¨æŒ‡å®šçš„é•œåƒç‰ˆæœ¬: ${{ inputs.image_version }}"
          fi
          
      - name: Build summary
        run: |
          echo "## ğŸ”§ æ„å»ºé…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é…ç½®é¡¹ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| å¼•ç”¨ç±»å‹ | ${{ steps.check_ref.outputs.ref_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»ºå¼•ç”¨ | ${{ inputs.ref }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é•œåƒç‰ˆæœ¬ | ${{ steps.determine_version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AMD64 | ${{ inputs.build_amd64 && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ARM64 | ${{ inputs.build_arm64 && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest æ ‡ç­¾ | ${{ inputs.push_latest && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é•œåƒç­¾å | ${{ inputs.sign_images && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY

  build-amd64:
    needs: prepare
    runs-on: self-hosted
    if: inputs.build_amd64
    
    env:
      docker.platform: linux/amd64
      IMAGE_VERSION: ${{ needs.prepare.outputs.final_image_version }}
      PLATFORM_SUFFIX: amd64

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. æ£€å‡ºä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. é…ç½® JDK21 + Mavenï¼ˆå¸¦ ~/.m2 ç¼“å­˜ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up JDK 21 & Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven
      
      - name: Set up Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.6

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. ç¼“å­˜ CNB å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache CNB layers
        uses: actions/cache@v4
        with:
          path: .cnb-cache
          key: cnb-${{ hashFiles('pom.xml') }}-amd64-${{ inputs.ref }}
          restore-keys: |
            cnb-${{ hashFiles('pom.xml') }}-amd64-
            cnb-${{ hashFiles('pom.xml') }}-

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. å¯ç”¨ QEMU & Buildx â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. ç™»å½•é•œåƒä»“åº“ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. æ„å»ºå¹¶æ¨é€ AMD64 é•œåƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Display Build Information
        run: |
          echo "=== æ„å»ºä¿¡æ¯ ==="
          echo "æ„å»ºå¼•ç”¨: ${{ inputs.ref }}"
          echo "å¼•ç”¨ç±»å‹: ${{ needs.prepare.outputs.ref_type }}"
          echo "é•œåƒç‰ˆæœ¬: ${{ env.IMAGE_VERSION }}"
          echo "æ„å»ºå¹³å°: linux/amd64"
          echo "é•œåƒæ ‡ç­¾: ${{ env.DOCKER_IMAGE_REPO }}/drinkup:${{ env.IMAGE_VERSION }}-${{ env.PLATFORM_SUFFIX }}"
          echo ""
          echo "Git ä¿¡æ¯:"
          git log -1 --pretty=format:"æäº¤: %H%nä½œè€…: %an <%ae>%næ—¥æœŸ: %ai%næ¶ˆæ¯: %s"
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"

      - name: Build Image (linux/amd64)
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"
        run: |
          mvn -B -ntp spring-boot:build-image \
            -Dspring-boot.build-image.image.name=${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-${{ env.PLATFORM_SUFFIX }} \
            -Dspring-boot.build-image.image.publish=false

      - name: Push Versioned Image
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"
        run: |
          docker push ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-${{ env.PLATFORM_SUFFIX }}

      - name: Fix CNB cache permissions
        if: always()
        run: |
          sudo chown -R $(id -u):$(id -g) .cnb-cache || true

  build-arm64:
    needs: prepare
    runs-on: self-hosted
    if: inputs.build_arm64
    
    env:
      docker.platform: linux/arm64
      IMAGE_VERSION: ${{ needs.prepare.outputs.final_image_version }}
      PLATFORM_SUFFIX: arm64

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. æ£€å‡ºä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. é…ç½® JDK21 + Mavenï¼ˆå¸¦ ~/.m2 ç¼“å­˜ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up JDK 21 & Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven
      
      - name: Set up Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.9.6

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. ç¼“å­˜ CNB å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache CNB layers
        uses: actions/cache@v4
        with:
          path: .cnb-cache
          key: cnb-${{ hashFiles('pom.xml') }}-arm64-${{ inputs.ref }}
          restore-keys: |
            cnb-${{ hashFiles('pom.xml') }}-arm64-
            cnb-${{ hashFiles('pom.xml') }}-

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. å¯ç”¨ QEMU & Buildx â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. ç™»å½•é•œåƒä»“åº“ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. æ„å»ºå¹¶æ¨é€ ARM64 é•œåƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Display Build Information
        run: |
          echo "=== æ„å»ºä¿¡æ¯ ==="
          echo "æ„å»ºå¼•ç”¨: ${{ inputs.ref }}"
          echo "å¼•ç”¨ç±»å‹: ${{ needs.prepare.outputs.ref_type }}"
          echo "é•œåƒç‰ˆæœ¬: ${{ env.IMAGE_VERSION }}"
          echo "æ„å»ºå¹³å°: linux/arm64"
          echo "é•œåƒæ ‡ç­¾: ${{ env.DOCKER_IMAGE_REPO }}/drinkup:${{ env.IMAGE_VERSION }}-${{ env.PLATFORM_SUFFIX }}"
          echo ""
          echo "Git ä¿¡æ¯:"
          git log -1 --pretty=format:"æäº¤: %H%nä½œè€…: %an <%ae>%næ—¥æœŸ: %ai%næ¶ˆæ¯: %s"
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"

      - name: Build Image (linux/arm64)
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"
        run: |
          mvn -B -ntp spring-boot:build-image \
            -Dspring-boot.build-image.image.name=${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-${{ env.PLATFORM_SUFFIX }} \
            -Dspring-boot.build-image.image.publish=false

      - name: Push Versioned Image
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"
        run: |
          docker push ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-${{ env.PLATFORM_SUFFIX }}

      - name: Fix CNB cache permissions
        if: always()
        run: |
          sudo chown -R $(id -u):$(id -g) .cnb-cache || true

  manifest:
    needs: [prepare, build-amd64, build-arm64]
    runs-on: self-hosted
    if: |
      always() && 
      (needs.build-amd64.result == 'success' || needs.build-arm64.result == 'success' || 
       needs.build-amd64.result == 'skipped' || needs.build-arm64.result == 'skipped') &&
      !(needs.build-amd64.result == 'skipped' && needs.build-arm64.result == 'skipped')
    
    env:
      IMAGE_VERSION: ${{ needs.prepare.outputs.final_image_version }}
    
    steps:
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. åˆ›å»ºå¤šæ¶æ„ manifest â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Multi-Arch Manifest for Version
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"
        run: |
          # æ„å»ºé•œåƒåˆ—è¡¨
          images=""
          
          # æ£€æŸ¥å“ªäº›æ¶æ„æ„å»ºæˆåŠŸ
          if [[ "${{ needs.build-amd64.result }}" == "success" ]]; then
            images="${images} ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-amd64"
            echo "åŒ…å« AMD64 æ¶æ„"
          fi
          
          if [[ "${{ needs.build-arm64.result }}" == "success" ]]; then
            images="${images} ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-arm64"
            echo "åŒ…å« ARM64 æ¶æ„"
          fi
          
          # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾çš„ manifest
          echo "åˆ›å»ºå¤šæ¶æ„ manifest: ${{ env.IMAGE_VERSION }}"
          docker buildx imagetools create \
            --tag ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }} \
            $images

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8. å¯é€‰ï¼šåˆ›å»º latest æ ‡ç­¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Latest Tag
        if: inputs.push_latest == true
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"
        run: |
          images=""
          
          if [[ "${{ needs.build-amd64.result }}" == "success" ]]; then
            images="${images} ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-amd64"
          fi
          
          if [[ "${{ needs.build-arm64.result }}" == "success" ]]; then
            images="${images} ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-arm64"
          fi
          
          # åˆ›å»º latest æ ‡ç­¾
          echo "åˆ›å»º latest æ ‡ç­¾"
          docker buildx imagetools create \
            --tag ${DOCKER_IMAGE_REPO}/drinkup:latest \
            $images

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 9. å¯é€‰ï¼šç­¾åé•œåƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Cosign
        if: inputs.sign_images == true
        uses: sigstore/cosign-installer@main
        with:
          cosign-release: 'v2.2.2'
      
      - name: Sign Images with Cosign
        if: inputs.sign_images == true
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: |
          echo "$COSIGN_PRIVATE_KEY" > cosign.key
          
          # ç­¾åç‰ˆæœ¬æ ‡ç­¾
          cosign sign --key cosign.key ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}
          
          # ç­¾åå„æ¶æ„é•œåƒ
          if [[ "${{ needs.build-amd64.result }}" == "success" ]]; then
            cosign sign --key cosign.key ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-amd64
          fi
          
          if [[ "${{ needs.build-arm64.result }}" == "success" ]]; then
            cosign sign --key cosign.key ${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-arm64
          fi
          
          # å¦‚æœæ¨é€äº† latestï¼Œä¹Ÿç­¾å latest
          if [[ "${{ inputs.push_latest }}" == "true" ]]; then
            cosign sign --key cosign.key ${DOCKER_IMAGE_REPO}/drinkup:latest
          fi
          
          rm -f cosign.key

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10. è¾“å‡ºæ„å»ºç»“æœ â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Summary
        env:
          DOCKER_IMAGE_REPO: "${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_ORG }}"
        run: |
          echo "## ğŸ‰ æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºå¼•ç”¨**: ${{ inputs.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¼•ç”¨ç±»å‹**: ${{ needs.prepare.outputs.ref_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ env.IMAGE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: ${DOCKER_IMAGE_REPO}/drinkup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ„å»ºçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build-amd64.result }}" == "success" ]]; then
            echo "- âœ… AMD64: æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build-amd64.result }}" == "skipped" ]]; then
            echo "- â­ï¸ AMD64: å·²è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ AMD64: æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.build-arm64.result }}" == "success" ]]; then
            echo "- âœ… ARM64: æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build-arm64.result }}" == "skipped" ]]; then
            echo "- â­ï¸ ARM64: å·²è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ ARM64: æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ç”Ÿæˆçš„é•œåƒæ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
          echo "- \`${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}\` (å¤šæ¶æ„)" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.build-amd64.result }}" == "success" ]]; then
            echo "- \`${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-amd64\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.build-arm64.result }}" == "success" ]]; then
            echo "- \`${DOCKER_IMAGE_REPO}/drinkup:${{ env.IMAGE_VERSION }}-arm64\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ inputs.push_latest }}" == "true" ]]; then
            echo "- \`${DOCKER_IMAGE_REPO}/drinkup:latest\` (å¤šæ¶æ„)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.sign_images }}" == "true" ]]; then
            echo "âœ… æ‰€æœ‰é•œåƒå·²ä½¿ç”¨ Cosign ç­¾å" >> $GITHUB_STEP_SUMMARY
          fi
